<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWGOH Master Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f1f5f9; margin: 0; padding: 0; font-family: sans-serif; }
        .header-bg { background-color: #1e293b; border-bottom: 1px solid #334155; }
        
        /* Table Layout */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        
        /* Sticky Headers */
        th { 
            background-color: #1e293b; 
            color: #60a5fa; 
            text-align: left; 
            padding: 10px; 
            border: 1px solid #334155;
            font-size: 0.65rem;
            cursor: pointer;
            text-transform: uppercase;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th:hover { background-color: #334155; }
        
        td { 
            padding: 6px 10px; 
            border: 1px solid #1e293b; 
            font-size: 0.75rem;
            white-space: nowrap;
        }
        
        /* Mod Comparison Colors */
        .match-green { background-color: #166534 !important; color: #bbf7d0; }
        .mismatch-red { background-color: #991b1b !important; color: #fecaca; }
        .neutral-cell { background-color: #1e293b; }
        
        tr:nth-child(even) { background-color: #111827; }
        tr:hover td { filter: brightness(1.2); }
    </style>
</head>
<body>

    <!-- Top Bar with Metadata -->
    <header class="header-bg p-4 shadow-xl flex justify-between items-center">
        <div>
            <h1 class="text-xl font-black text-blue-400 tracking-tighter">SWGOH MASTER DATA</h1>
            <div id="player-summary" class="text-slate-400 text-[10px] uppercase tracking-widest mt-1">
                Loading data...
            </div>
        </div>
        <div id="build-info" class="text-[9px] text-slate-500 font-mono text-right"></div>
    </header>

    <!-- Main Data Table -->
    <div class="table-container">
        <table id="master-table">
            <thead>
                <tr id="header-row">
                    <th onclick="sortTable('name')">Name</th>
                    <th onclick="sortTable('level')">Lvl</th>
                    <th onclick="sortTable('stars')">Stars</th>
                    <th onclick="sortTable('gear')">Gear</th>
                    <th onclick="sortTable('set bonus')">Set</th>
                    <th onclick="sortTable('square')">Square</th>
                    <th onclick="sortTable('arrow')">Arrow</th>
                    <th onclick="sortTable('diamond')">Diamond</th>
                    <th onclick="sortTable('triangle')">Triangle</th>
                    <th onclick="sortTable('circle')">Circle</th>
                    <th onclick="sortTable('cross')">Cross</th>
                    <th onclick="sortTable('rec bonus')">Rec Set</th>
                    <th onclick="sortTable('arrow(r)')">Arrow(r)</th>
                    <th onclick="sortTable('triangle(r)')">Tri(r)</th>
                    <th onclick="sortTable('circle(r)')">Circ(r)</th>
                    <th onclick="sortTable('cross(r)')">Cross(r)</th>
                    <th onclick="sortTable('kyro')">Kyro</th>
                    <th onclick="sortTable('url')">URL</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="18" class="text-center py-20 text-slate-500 italic">Initializing...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const JSON_FILE = 'db_master_data.json';
        let unitsData = [];
        let sortConfig = { key: null, direction: 1 };

        /**
         * Normalizes strings for logical comparison (e.g. "Crit Damage" vs "Critical Damage")
         */
        function normalizeStat(val) {
            if (!val || val === "-") return "";
            return val.toString().toLowerCase()
                      .replace(/critical/g, 'crit')
                      .replace(/damage/g, 'dmg')
                      .trim();
        }

        /**
         * Determines CSS class based on comparison between equipped and recommended mods
         */
        function getModClass(equippedValue, type, unit) {
            const recKey = type + "(r)";
            const recValue = unit[recKey];
            
            if (!equippedValue || equippedValue === "-" || !recValue || recValue === "-") {
                return "neutral-cell";
            }
            
            return normalizeStat(equippedValue) === normalizeStat(recValue) ? "match-green" : "mismatch-red";
        }

        /**
         * Fetches JSON and populates the table
         */
        async function loadDashboard() {
            try {
                const response = await fetch(JSON_FILE);
                const data = await response.json();
                
                // Update header with metadata
                const meta = data.metadata;
                document.getElementById('player-summary').innerHTML = 
                    `Player: <span class="text-white">${meta.player_name}</span> | GP: <span class="text-white">${Number(meta.galactic_power).toLocaleString()}</span>`;
                document.getElementById('build-info').textContent = `Build: ${meta.generated_at}`;

                unitsData = data.units;
                renderTable(unitsData);
            } catch (err) {
                document.getElementById('table-body').innerHTML = 
                    `<tr><td colspan="18" class="text-center py-20 text-rose-500 font-bold">Error loading JSON: ${err.message}</td></tr>`;
            }
        }

        /**
         * Renders table rows based on the provided units array
         */
        function renderTable(units) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            units.forEach(u => {
                const tr = document.createElement('tr');
                
                // Column definitions mapping to JSON keys
                const columns = [
                    { key: "name", class: "font-bold text-blue-300" },
                    { key: "level", class: "text-center" },
                    { key: "stars", class: "text-center font-bold" },
                    { key: "gear", class: "text-center font-bold text-slate-200" },
                    { key: "set bonus", class: "text-[10px] text-slate-400" },
                    { key: "square", class: "neutral-cell" },
                    { key: "arrow", compare: "arrow" },
                    { key: "diamond", class: "neutral-cell" },
                    { key: "triangle", compare: "triangle" },
                    { key: "circle", compare: "circle" },
                    { key: "cross", compare: "cross" },
                    { key: "rec bonus", class: "text-[10px] text-blue-400/50" },
                    { key: "arrow(r)", class: "text-slate-500" },
                    { key: "triangle(r)", class: "text-slate-500" },
                    { key: "circle(r)", class: "text-slate-500" },
                    { key: "cross(r)", class: "text-slate-500" },
                    { key: "kyro", class: "text-center text-orange-400 font-mono font-bold" },
                    { key: "url", isLink: true }
                ];

                columns.forEach(col => {
                    const td = document.createElement('td');
                    const rawValue = u[col.key] !== undefined ? u[col.key] : "-";
                    
                    // Apply classes
                    if (col.class) td.className = col.class;
                    
                    // Logic for mod color coding
                    if (col.compare) {
                        td.className = getModClass(rawValue, col.compare, u);
                    }

                    // Content rendering
                    if (col.isLink) {
                        td.innerHTML = `<a href="${rawValue}" target="_blank" class="text-blue-500 hover:text-blue-300 underline">Link</a>`;
                    } else {
                        td.textContent = rawValue;
                    }

                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        /**
         * Sorts unitsData and re-renders the table
         */
        function sortTable(key) {
            if (sortConfig.key === key) {
                sortConfig.direction *= -1;
            } else {
                sortConfig.key = key;
                sortConfig.direction = 1;
            }

            unitsData.sort((a, b) => {
                let v1 = a[key] === undefined ? "" : a[key];
                let v2 = b[key] === undefined ? "" : b[key];

                // Numeric sorting
                const n1 = parseFloat(v1);
                const n2 = parseFloat(v2);
                if (!isNaN(n1) && !isNaN(n2)) {
                    return (n1 - n2) * sortConfig.direction;
                }

                // String sorting
                return String(v1).localeCompare(String(v2)) * sortConfig.direction;
            });

            renderTable(unitsData);
        }

        window.onload = loadDashboard;
    </script>
</body>
</html>
