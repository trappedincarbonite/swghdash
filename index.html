<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWGOH Master Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f1f5f9; margin: 0; padding: 0; font-family: sans-serif; }
        .header-bg { background-color: #1e293b; border-bottom: 1px solid #334155; }
        
        /* Table Styles */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th { 
            background-color: #1e293b; 
            color: #60a5fa; 
            text-align: left; 
            padding: 12px 10px; 
            border: 1px solid #334155;
            font-size: 0.65rem;
            cursor: pointer;
            text-transform: uppercase;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th:hover { background-color: #334155; }
        td { 
            padding: 6px 10px; 
            border: 1px solid #1e293b; 
            font-size: 0.75rem;
            white-space: nowrap;
        }
        
        /* Matching Logic Colors */
        .match-green { background-color: #166534 !important; color: #bbf7d0; }
        .mismatch-red { background-color: #991b1b !important; color: #fecaca; }
        .neutral-cell { background-color: #1e293b; }
        
        tr:nth-child(even) { background-color: #111827; }
        tr:hover td { filter: brightness(1.3); }

        /* Hide horizontal scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <!-- Header Section -->
    <header class="header-bg p-4 shadow-xl flex justify-between items-center">
        <div>
            <h1 class="text-xl font-black text-blue-400 tracking-tighter">SWGOH MASTER DATA</h1>
            <div id="player-summary" class="text-slate-400 text-[10px] uppercase tracking-widest mt-1">
                Laddar spelarinformation...
            </div>
        </div>
        <div id="build-info" class="text-[9px] text-slate-500 font-mono text-right"></div>
    </header>

    <!-- Dashboard Table -->
    <div class="table-container no-scrollbar">
        <table id="master-table">
            <thead>
                <tr id="header-row">
                    <!-- Table headers are generated from JSON keys to avoid "undefined" errors -->
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="20" class="text-center py-20 text-slate-500 italic">Väntar på data från db_master_data.json...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const DATA_PATH = 'db_master_data.json';
        let masterData = [];
        let sortState = { col: null, desc: false };

        /**
         * Cleans and normalizes strings for comparison
         */
        function normalize(str) {
            if (!str || str === "-") return "";
            return str.toString().toLowerCase()
                      .replace(/critical/g, 'crit')
                      .replace(/damage/g, 'dmg')
                      .trim();
        }

        /**
         * Logic to determine if equipped mod matches recommendation
         */
        function getCellColorClass(val, key, unit) {
            const compareMap = {
                "Arrow": "Arrow(r)",
                "Triangle": "Triangle(r)",
                "Circle": "Circle(r)",
                "Cross": "Cross(r)"
            };

            const recKey = compareMap[key];
            if (!recKey || !unit[recKey] || unit[recKey] === "-") return "neutral-cell";
            
            return normalize(val) === normalize(unit[recKey]) ? "match-green" : "mismatch-red";
        }

        /**
         * Main load function
         */
        async function init() {
            try {
                const response = await fetch(DATA_PATH);
                const data = await response.json();
                
                // Update Metadata
                const meta = data.metadata;
                document.getElementById('player-summary').innerHTML = 
                    `Spelare: <span class="text-white">${meta.player_name}</span> | GP: <span class="text-white">${Number(meta.galactic_power).toLocaleString()}</span>`;
                document.getElementById('build-info').textContent = `Senast uppdaterad: ${meta.generated_at}`;

                masterData = data.units;
                if (masterData.length > 0) {
                    createHeaders(masterData[0]);
                    renderTable(masterData);
                }
            } catch (err) {
                document.getElementById('table-body').innerHTML = 
                    `<tr><td colspan="20" class="text-center py-20 text-red-500">Kunde inte läsa JSON-filen. Kontrollera att den finns på GitHub.</td></tr>`;
                console.error("Fetch error:", err);
            }
        }

        /**
         * Creates headers dynamically based on the keys in the first JSON unit object
         */
        function createHeaders(firstUnit) {
            const headerRow = document.getElementById('header-row');
            headerRow.innerHTML = '';
            
            Object.keys(firstUnit).forEach((key, index) => {
                const th = document.createElement('th');
                th.textContent = key;
                th.onclick = () => sortTable(key);
                headerRow.appendChild(th);
            });
        }

        /**
         * Renders the rows into the table body
         */
        function renderTable(units) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            units.forEach(unit => {
                const tr = document.createElement('tr');
                
                Object.entries(unit).forEach(([key, value]) => {
                    const td = document.createElement('td');
                    const displayValue = (value === undefined || value === null) ? "-" : value;
                    
                    // Specific styling for certain columns
                    if (key === "Name") td.classList.add("font-bold", "text-blue-300");
                    if (key === "Gear") td.classList.add("font-bold", "text-slate-100", "text-center");
                    if (key === "Kyro") td.classList.add("text-orange-400", "font-mono", "text-center");
                    if (key === "Stars" || key === "Level") td.classList.add("text-center");
                    
                    // Mod comparison coloring
                    const colorClass = getCellColorClass(displayValue, key, unit);
                    if (colorClass !== "neutral-cell") td.classList.add(colorClass);

                    // Handle URL as link
                    if (key.toLowerCase() === "url") {
                        td.innerHTML = `<a href="${displayValue}" target="_blank" class="text-blue-500 hover:underline italic">Link</a>`;
                    } else {
                        td.textContent = displayValue;
                    }

                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        /**
         * Sorts the table by key
         */
        function sortTable(key) {
            sortState.desc = (sortState.col === key) ? !sortState.desc : false;
            sortState.col = key;

            const sorted = [...masterData].sort((a, b) => {
                let v1 = a[key];
                let v2 = b[key];

                // Numeric sort
                const n1 = parseFloat(v1);
                const n2 = parseFloat(v2);
                if (!isNaN(n1) && !isNaN(n2)) {
                    return sortState.desc ? n2 - n1 : n1 - n2;
                }

                // String sort
                return sortState.desc 
                    ? String(v2).localeCompare(String(v1)) 
                    : String(v1).localeCompare(String(v2));
            });

            renderTable(sorted);
        }

        window.onload = init;
    </script>
</body>
</html>
