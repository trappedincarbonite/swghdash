<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWGHDash Mod Comparator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0a0e1a;
            color: #e2e8f0;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header-bg { background-color: #0f172a; border-bottom: 1px solid #1e293b; }
        
        .stat-label { color: #94a3b8; font-size: 1.25rem; font-weight: 700; text-transform: uppercase; letter-spacing: -0.025em; }
        .stat-value { color: #eab308; font-size: 1.25rem; font-weight: 700; }
        
        .table-container { 
            background-color: #111827; 
            border: 1px solid #1f2937; 
            border-radius: 0.25rem; 
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.72rem; }
        th { 
            background-color: #1f2937; 
            color: #94a3b8; 
            text-align: left; 
            padding: 0.5rem 0.6rem; 
            border-bottom: 1px solid #374151;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.6rem;
        }
        td { 
            padding: 0.5rem 0.6rem; 
            border-bottom: 1px solid #1f2937; 
            border-right: 1px solid #1f2937; 
            white-space: nowrap;
        }
        
        .search-input { 
            background-color: #1e293b; 
            border: 1px solid #334155; 
            color: white; 
            border-radius: 0.25rem; 
            padding: 0.3rem 0.8rem; 
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .loading-spinner {
            border: 3px solid rgba(255,255,255,.1);
            border-radius: 50%;
            border-top: 3px solid #eab308;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #build-tag {
            font-family: monospace;
            font-size: 0.65rem;
            color: #475569;
            margin-top: auto;
            padding: 1rem 0;
            text-align: center;
        }
    </style>
</head>
<body class="p-4" onload="initDashboard()">

    <header id="player-header" class="header-bg p-4 mb-6 flex flex-wrap items-center justify-between rounded-md">
        <div class="flex items-center space-x-12">
            <h1 class="text-3xl font-black text-yellow-500 tracking-tighter mr-4">SWGHDash</h1>
            <div id="stats-grid" class="flex items-center space-x-12">
                <div class="flex items-center space-x-3">
                    <div class="loading-spinner"></div>
                    <span class="text-xs text-slate-400">Hämtar data från Markdown...</span>
                </div>
            </div>
        </div>
        <div>
            <input type="text" id="charSearch" oninput="filterCharacters()" placeholder="Search Characters..." class="search-input text-sm w-64 focus:outline-none focus:ring-1 focus:ring-yellow-500">
        </div>
    </header>

    <main class="grid grid-cols-1 xl:grid-cols-12 gap-4 flex-grow">
        <section class="xl:col-span-5">
            <h2 class="text-[10px] font-bold mb-1 uppercase tracking-widest text-slate-400 px-1">Karaktärer</h2>
            <div class="table-container max-h-[75vh] overflow-y-auto shadow-2xl">
                <table id="units-table">
                    <thead>
                        <tr>
                            <th>Namn</th>
                            <th class="text-center">Lvl</th>
                            <th class="text-center">Stars</th>
                            <th class="text-center">Gear / Relic</th>
                        </tr>
                    </thead>
                    <tbody id="units-body"></tbody>
                </table>
            </div>
        </section>

        <section class="xl:col-span-7">
            <div class="table-container p-8 text-center text-slate-500 italic h-full flex items-center justify-center">
                Välj en enhet för att se mer information.
            </div>
        </section>
    </main>

    <footer id="build-tag">build_260212_234800</footer>

    <script>
        let fullData = { units: [], playerMd: null };

        // Formaterar siffror med tusentalsavgränsare (t.ex. 1 234 567)
        function formatNum(num) {
            if (!num || isNaN(num.toString().replace(/\s/g, ''))) return num;
            const cleanNum = Number(num.toString().replace(/\s/g, ''));
            return cleanNum.toLocaleString('sv-SE');
        }

        // Parsar unit_data.md
        function parseUnitMarkdown(mdText) {
            const lines = mdText.trim().split('\n');
            const tableStartIndex = lines.findIndex(l => l.includes('| name |'));
            if (tableStartIndex === -1) return [];

            const dataLines = lines.slice(tableStartIndex + 2); // Skippa header och separator
            
            return dataLines.map(line => {
                const cols = line.split('|').map(s => s.trim()).filter(s => s !== '');
                if (cols.length < 8) return null;
                return {
                    name: cols[0],
                    base_id: cols[1],
                    level: cols[2],
                    rarity: cols[3],
                    gear_level: cols[4],
                    relic_tier: cols[5],
                    power: cols[6],
                    combat_type: cols[7]
                };
            }).filter(u => u !== null);
        }

        // Parsar player_data.md
        function parsePlayerMarkdown(mdText) {
            const lines = mdText.trim().split('\n');
            if (lines.length < 3) return [];
            const headers = lines[0].split('|').map(s => s.trim()).filter(s => s !== '');
            const values = lines[2].split('|').map(s => s.trim()).filter(s => s !== '');
            return headers.map((h, i) => ({ label: h, value: values[i] || '-' }));
        }

        async function initDashboard() {
            try {
                const [unitMdRes, playerMdRes] = await Promise.all([
                    fetch('unit_data.md').then(r => r.text()),
                    fetch('player_data.md').then(r => r.text())
                ]);

                const allUnits = parseUnitMarkdown(unitMdRes);
                
                // Filtrera på combat_type 1 (Karaktärer) och sortera (siffror först, sen bokstavsordning)
                fullData.units = allUnits
                    .filter(u => u.combat_type === "1")
                    .sort((a, b) => a.name.localeCompare(b.name, 'sv', { numeric: true, sensitivity: 'base' }));
                
                fullData.playerMd = parsePlayerMarkdown(playerMdRes);

                renderHeader(fullData.playerMd);
                renderTables(fullData.units);
            } catch (err) {
                console.error("Fetch error:", err);
                document.getElementById('stats-grid').innerHTML = `<span class="text-rose-500 text-xs">Error loading Markdown files.</span>`;
            }
        }

        function renderHeader(stats) {
            const grid = document.getElementById('stats-grid');
            if (!stats || stats.length < 1) return;

            const row = (s) => `
                <div class="flex items-center space-x-3">
                    <span class="stat-label whitespace-nowrap">${s.label}</span>
                    <span class="stat-value">${formatNum(s.value)}</span>
                </div>
            `;

            grid.innerHTML = `
                <div class="flex items-center space-x-4 pr-6 border-r border-slate-800">
                    <span class="stat-label">${stats[0].label}</span>
                    <span class="text-3xl font-black text-yellow-500">${formatNum(stats[0].value)}</span>
                </div>
                <div class="flex flex-col justify-center space-y-1">
                    ${stats.slice(1, 3).map(s => row(s)).join('')}
                </div>
                <div class="flex flex-col justify-center space-y-1">
                    ${stats.slice(3, 5).map(s => row(s)).join('')}
                </div>
                <div class="flex flex-col justify-center space-y-1">
                    ${stats.slice(5, 7).map(s => row(s)).join('')}
                </div>
            `;
        }

        function renderTables(units, filter = '') {
            const unitsBody = document.getElementById('units-body');
            if (!unitsBody) return;
            unitsBody.innerHTML = '';

            units.forEach(unit => {
                if (filter && !unit.name.toLowerCase().includes(filter.toLowerCase())) return;

                const relicVal = parseInt(unit.relic_tier);
                // Relic tier 1 & 2 är tekniskt sett gear 13, R1 börjar vid 3
                const relicDisplay = (relicVal > 2) 
                    ? ` <span class="text-blue-400 font-bold">R${relicVal - 2}</span>` 
                    : '';

                unitsBody.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-slate-800/50 transition-colors">
                        <td class="font-semibold text-slate-200">${unit.name}</td>
                        <td class="text-center">${formatNum(unit.level)}</td>
                        <td class="text-center text-yellow-500 font-bold">${unit.rarity}*</td>
                        <td class="text-center">G${unit.gear_level}${relicDisplay}</td>
                    </tr>
                `);
            });
        }

        function filterCharacters() {
            const val = document.getElementById('charSearch').value;
            renderTables(fullData.units, val);
        }
    </script>
</body>
</html>
