<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWGOH Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f1f5f9; margin: 0; padding: 0; }
        .card { background-color: #1e293b; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        table { width: 100%; border-collapse: collapse; }
        th { 
            background-color: #1e293b; 
            color: #60a5fa; 
            text-align: left; 
            padding: 12px 8px; 
            border: 1px solid #334155;
            font-size: 0.65rem;
            cursor: pointer;
            text-transform: uppercase;
            white-space: nowrap;
        }
        th:hover { background-color: #334155; }
        td { 
            padding: 6px 8px; 
            border: 1px solid #1e293b; 
            font-size: 0.75rem;
            white-space: nowrap;
        }
        
        .match-green { background-color: #166534 !important; color: #bbf7d0; }
        .mismatch-red { background-color: #991b1b !important; color: #fecaca; }
        .neutral-cell { background-color: #1e293b; }
        
        tr:hover td { background-color: #334155; }
        .sticky-header { position: sticky; top: 0; z-index: 20; }
    </style>
</head>
<body class="p-4">
    <div class="w-full">
        <header class="mb-8 border-b border-slate-700 pb-4 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-bold text-blue-400">SWGOH Dashboard</h1>
                <div id="player-summary" class="text-slate-400 mt-2 text-sm uppercase tracking-widest">
                    Awaiting data...
                </div>
            </div>
            <div id="data-status" class="text-xs text-slate-500"></div>
        </header>

        <main id="app">
            <div id="status" class="card mb-6">
                <p class="text-yellow-400">Loading db_master_data.json...</p>
            </div>

            <div id="content" class="hidden">
                <div class="overflow-x-auto rounded-lg border border-slate-700 bg-[#1e293b]">
                    <table id="master-table">
                        <thead class="sticky-header">
                            <tr>
                                <!-- Column 1 is explicitly "Name" now -->
                                <th onclick="sortTable(0)">Name</th>
                                <th onclick="sortTable(1)">Level</th>
                                <th onclick="sortTable(2)">Stars</th>
                                <th onclick="sortTable(3)">Gear</th>
                                <th onclick="sortTable(4)">Set Bonus (E)</th>
                                <th onclick="sortTable(5)">Arrow</th>
                                <th onclick="sortTable(6)">Triangle</th>
                                <th onclick="sortTable(7)">Circle</th>
                                <th onclick="sortTable(8)">Cross</th>
                                <th onclick="sortTable(9)">Square</th>
                                <th onclick="sortTable(10)">Diamond</th>
                                <th onclick="sortTable(11)">Set Bonus (R)</th>
                                <th onclick="sortTable(12)">Arrow (R)</th>
                                <th onclick="sortTable(13)">Triangle (R)</th>
                                <th onclick="sortTable(14)">Circle (R)</th>
                                <th onclick="sortTable(15)">Cross (R)</th>
                                <th onclick="sortTable(16)">Kyro</th>
                                <th onclick="sortTable(17)">URL</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const DATA_URL = 'db_master_data.json';
        let masterData = null;
        let sortOrder = { index: 0, asc: true };

        /**
         * Mapping shifted by +1 to match the JSON's specific data structure
         * e.g., Game Potency (6) is represented as 7 in this specific JSON
         */
        const setMap = {
            "2": "Health", "3": "Offense", "4": "Defense", "5": "Speed", 
            "6": "Crit Chance", "7": "Potency", "8": "Tenacity", "9": "Crit Damage"
        };

        function cleanName(name) {
            if (!name) return "";
            return name.replace(/\\/g, '"');
        }

        function formatGear(gear, relic) {
            const g = parseInt(gear) || 0;
            const r = parseInt(relic) || 0;
            if (g === 13 && r >= 3) return `R${r - 2}`;
            return `G${g}`;
        }

        /**
         * Using the shifted setMap to calculate equipped bonuses
         */
        function getEquippedSetBonus(charId, mods) {
            if (!mods || !Array.isArray(mods)) return "-";
            const charMods = mods.filter(m => m.character === charId);
            if (charMods.length === 0) return "-";
            const counts = {};
            charMods.forEach(m => {
                const name = setMap[m.set] || "Unknown";
                counts[name] = (counts[name] || 0) + 1;
            });
            return Object.entries(counts)
                .map(([name, count]) => `${name} (${count})`)
                .join(" ");
        }

        function getModClass(eqVal, recVal) {
            if (eqVal === "-" || !recVal) return "neutral-cell";
            const norm = (s) => s.toLowerCase().replace(/critical/g, 'crit').replace(/damage/g, 'dmg').trim();
            return norm(eqVal) === norm(recVal) ? "match-green" : "mismatch-red";
        }

        /**
         * Adjusted getStat to look for slot + 1 
         * Game Slot 1 (Square) -> JSON Slot 2
         * Game Slot 2 (Arrow)  -> JSON Slot 3
         * ...and so on, based on user feedback on data misalignment.
         */
        function getStat(charMods, slot) {
            const shiftedSlot = slot + 1; 
            const mod = charMods.find(m => m.slot == shiftedSlot);
            return mod ? mod.pri_stat : "-";
        }

        async function loadData() {
            const statusEl = document.getElementById('status');
            const contentEl = document.getElementById('content');
            const playerSummary = document.getElementById('player-summary');

            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error(`Fetch failed: ${response.status}`);
                masterData = await response.json();

                const p = masterData.player || {};
                const gp = p.galactic_power ? Number(p.galactic_power).toLocaleString('sv-SE') : "0";
                playerSummary.innerHTML = `Player: <b class="text-blue-400">${p.name || 'Unknown'}</b> | GP: <b class="text-blue-400">${gp}</b>`;
                
                if (masterData.metadata) {
                    document.getElementById('data-status').textContent = `Build: ${masterData.metadata.generated_at}`;
                }

                statusEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
                renderTable();

            } catch (error) {
                console.error("Data Load Error:", error);
                statusEl.innerHTML = `<p class="text-red-500 font-bold">Error: ${error.message}</p>`;
            }
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            const rawUnits = masterData.units || [];
            let characters = rawUnits.filter(u => {
                const d = u.data || u;
                return String(d.combat_type) === "1" && parseInt(d.rarity) > 0;
            });

            characters.sort((a, b) => cleanName((a.data || a).name).localeCompare(cleanName((b.data || b).name)));

            const kyroMap = {};
            if (masterData.kyro?.characters) {
                masterData.kyro.characters.forEach(c => kyroMap[c.name] = c.total_kyros);
            }

            characters.forEach(unit => {
                const u = unit.data || unit;
                const charId = u.base_id;
                const charName = cleanName(u.name);
                
                const charMods = (masterData.mods_equipped || []).filter(m => m.character === charId);
                const rec = (masterData.mods_recommended || []).find(r => r.base_id === charId);
                const kyroValue = kyroMap[u.name] || 0;

                // Stat fetching with the new offset logic
                const arrow = getStat(charMods, 2);
                const triangle = getStat(charMods, 4);
                const circle = getStat(charMods, 5);
                const cross = getStat(charMods, 6);
                const square = getStat(charMods, 1);
                const diamond = getStat(charMods, 3);

                const rs = rec?.primaries || {};

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-bold text-blue-300">${charName}</td>
                    <td class="text-center">${u.level || 0}</td>
                    <td class="text-center text-yellow-500 font-bold">${u.rarity || 0}â˜…</td>
                    <td class="text-center font-bold text-slate-200">${formatGear(u.gear_level, u.relic_tier)}</td>
                    <td class="text-[10px] text-slate-400">${getEquippedSetBonus(charId, masterData.mods_equipped)}</td>
                    
                    <td class="${getModClass(arrow, rs.arrow)}">${arrow}</td>
                    <td class="${getModClass(triangle, rs.triangle)}">${triangle}</td>
                    <td class="${getModClass(circle, rs.circle)}">${circle}</td>
                    <td class="${getModClass(cross, rs.cross)}">${cross}</td>
                    <td class="neutral-cell">${square}</td>
                    <td class="neutral-cell">${diamond}</td>
                    
                    <td class="text-[10px] text-blue-400/60">${rec ? rec.mod_sets.map(s => `${s.set} (${s.count})`).join(" ") : "-"}</td>
                    <td class="text-slate-500">${rs.arrow || "-"}</td>
                    <td class="text-slate-500">${rs.triangle || "-"}</td>
                    <td class="text-slate-500">${rs.circle || "-"}</td>
                    <td class="text-slate-500">${rs.cross || "-"}</td>
                    
                    <td class="text-center text-orange-400 font-mono font-bold">${kyroValue}</td>
                    <td><a href="${rec?.url || '#'}" target="_blank" class="text-blue-400 underline hover:text-blue-200">url</a></td>
                `;
                tbody.appendChild(row);
            });
        }

        function sortTable(index) {
            sortOrder.asc = (sortOrder.index === index) ? !sortOrder.asc : true;
            sortOrder.index = index;
            const tbody = document.getElementById('table-body');
            const rows = Array.from(tbody.rows);
            rows.sort((a, b) => {
                let valA = a.cells[index].innerText.trim();
                let valB = b.cells[index].innerText.trim();
                const nA = parseFloat(valA.replace(/[^0-9.]/g, ''));
                const nB = parseFloat(valB.replace(/[^0-9.]/g, ''));
                if (!isNaN(nA) && !isNaN(nB)) return sortOrder.asc ? nA - nB : nB - nA;
                return sortOrder.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
            });
            rows.forEach(row => tbody.appendChild(row));
        }

        window.onload = loadData;
    </script>
</body>
</html>
